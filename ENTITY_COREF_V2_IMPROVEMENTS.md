# Entity Coref V2 스크립트 개선사항

## 문제점
`scripts/prepare_entity_coref_v2.py` 실행 시 HPLT 데이터셋의 2단계 병렬 품질 필터링에서 멈춤
- **원인**: 20,329,632개의 텍스트를 한 번에 `Pool.map()`으로 처리하려다 메모리 부족
- **증상**: "병렬 품질 필터링 (20 워커)" 메시지 이후 더 이상 진행 안됨

## 개선사항

### 1. **배치 처리 도입**
- HPLT: 100만개씩 배치로 분할 처리
- AIR-Bench: 50만개씩 배치로 분할 처리
- 메모리 사용량: 20GB+ → 5GB 이하로 감소

### 2. **imap_unordered 사용**
```python
# 이전 (메모리 비효율)
results = pool.map(quality_check_worker, raw_texts, chunksize=500)

# 개선 (메모리 효율)
batch_results = list(pool.imap_unordered(quality_check_worker, batch, chunksize=1000))
```
- 결과를 메모리에 한 번에 올리지 않고 스트리밍 방식으로 처리
- 순서가 중요하지 않은 필터링 작업에 최적

### 3. **chunksize 최적화**
- 500 → 1000으로 증가
- 프로세스 간 통신 오버헤드 감소

### 4. **진행 상황 표시**
```
배치 1/21: 1,000,000개 처리 중...
   → 523,145개 통과 | 누적: 523,145개 | 속도: 8245 docs/s
배치 2/21: 1,000,000개 처리 중...
   → 521,873개 통과 | 누적: 1,045,018개 | 속도: 8321 docs/s
```
- 배치별 진행 상황 출력
- 멈춘 것처럼 보이는 현상 방지

### 5. **명시적 메모리 관리**
```python
# 메모리 정리
del batch, batch_results, batch_filtered
gc.collect()
```
- 배치 처리 후 명시적으로 메모리 해제
- 장시간 실행 시 메모리 누수 방지

## 실행 방법

```bash
# 기존과 동일한 명령어
python scripts/prepare_entity_coref_v2.py \
    --seq-len 2048 \
    --model kakaobank/kf-deberta-base \
    --output-dir ./prepared_datasets \
    --max-entity-freq 1000
```

## 예상 결과

### HPLT Korean 처리
```
[2/2] 배치 병렬 품질 필터링 (20 워커)
  배치 1/21: 1,000,000개 처리 중...
     → 523,145개 통과 | 누적: 523,145개 | 속도: 8245 docs/s
  배치 2/21: 1,000,000개 처리 중...
     → 521,873개 통과 | 누적: 1,045,018개 | 속도: 8321 docs/s
  ...
  배치 21/21: 329,632개 처리 중...
     → 172,451개 통과 | 누적: 10,687,234개 | 속도: 8156 docs/s
✅ 2단계 완료: 10,687,234개 선별 (1309.2초)
   품질 통과율: 52.5%
⏱️  총 시간: 12042.3초
```

### AIR-Bench News 처리
```
[2/2] 배치 병렬 품질 필터링 (20 워커)
  배치 1/3: 500,000개 처리 중...
     → 287,234개 통과 | 누적: 287,234개 | 속도: 9543 docs/s
  배치 2/3: 500,000개 처리 중...
     → 289,156개 통과 | 누적: 576,390개 | 속도: 9512 docs/s
  배치 3/3: 245,783개 처리 중...
     → 141,523개 통과 | 누적: 717,913개 | 속도: 9487 docs/s
✅ 2단계 완료: 717,913개 선별 (75.7초)
   품질 통과율: 57.8%
⏱️  총 시간: 189.4초
```

## 주요 특징 유지

✅ **개수 제한 없음**: 모든 고품질 데이터 활용
✅ **개체 빈도 제한**: 최대 1,000회 (편향 방지)
✅ **병렬 처리**: 20 워커 활용 (속도 유지)
✅ **품질 필터**: NNP 비율, 문장 수 체크

## 개선 효과

| 항목 | 이전 | 개선 후 |
|-----|-----|--------|
| 메모리 사용량 | 20GB+ | ~5GB |
| 처리 속도 | 멈춤 | 8000+ docs/s |
| 진행 상황 | 불명확 | 배치별 표시 |
| 안정성 | 메모리 부족 | 안정적 처리 |
